% function compare_SPDs

    % This is a one-off function used to compare estimated vs. measured
    % SPDs

    clear
    clc
    
    %%
    
    addpath('C:\Users\Admin\Desktop\PAINTERS_COPILOT') % for access to color data and functions
    
    %% Input data
    
    stations = 420 : 40 : 660;

    % X_Rite_ColorChecker_Classic_2014, measured by Spectro 1
    lambda_act = 400 : 10 : 700;
    R_act = [0.0631900000000000,0.0640200000000000,0.0641400000000000,0.0645500000000000,0.0647500000000000,0.0658100000000000,0.0671800000000000,0.0684700000000000,0.0710300000000000,0.0736400000000000,0.0768200000000000,0.0784000000000000,0.0787500000000000,0.0796200000000000,0.0810700000000000,0.0833900000000000,0.0916600000000000,0.104070000000000,0.116920000000000,0.130240000000000,0.140770000000000,0.146900000000000,0.150430000000000,0.153000000000000,0.154110000000000,0.156310000000000,0.156340000000000,0.156430000000000,0.156200000000000,0.154600000000000,0.153930000000000;0.167560000000000,0.179060000000000,0.178570000000000,0.175740000000000,0.177410000000000,0.187090000000000,0.202740000000000,0.220140000000000,0.247530000000000,0.273570000000000,0.295060000000000,0.295490000000000,0.281880000000000,0.260490000000000,0.247660000000000,0.238220000000000,0.240840000000000,0.264000000000000,0.299340000000000,0.372030000000000,0.447750000000000,0.491640000000000,0.514300000000000,0.525170000000000,0.526610000000000,0.532870000000000,0.538770000000000,0.547390000000000,0.562760000000000,0.576990000000000,0.599280000000000;0.246020000000000,0.292720000000000,0.302160000000000,0.305410000000000,0.310190000000000,0.311090000000000,0.308230000000000,0.303530000000000,0.290380000000000,0.273790000000000,0.255350000000000,0.235390000000000,0.209690000000000,0.188430000000000,0.177320000000000,0.167520000000000,0.155510000000000,0.147440000000000,0.144320000000000,0.143000000000000,0.140670000000000,0.134260000000000,0.129560000000000,0.128510000000000,0.131590000000000,0.138310000000000,0.146840000000000,0.149890000000000,0.149500000000000,0.147940000000000,0.146330000000000;0.0468100000000000,0.0456100000000000,0.0466700000000000,0.0487300000000000,0.0528300000000000,0.0582300000000000,0.0626100000000000,0.0664900000000000,0.0734500000000000,0.0817900000000000,0.0960400000000000,0.113640000000000,0.130600000000000,0.145810000000000,0.152510000000000,0.151250000000000,0.148520000000000,0.139880000000000,0.127360000000000,0.117310000000000,0.108440000000000,0.103060000000000,0.100050000000000,0.0993800000000000,0.0983200000000000,0.0988800000000000,0.0985800000000000,0.0973000000000000,0.0989700000000000,0.100020000000000,0.101610000000000;0.333250000000000,0.430790000000000,0.434960000000000,0.426630000000000,0.413310000000000,0.394670000000000,0.379940000000000,0.369610000000000,0.349740000000000,0.329790000000000,0.305920000000000,0.276530000000000,0.252810000000000,0.235190000000000,0.222010000000000,0.206560000000000,0.187210000000000,0.163900000000000,0.155570000000000,0.175440000000000,0.203600000000000,0.238640000000000,0.267570000000000,0.294650000000000,0.328900000000000,0.358280000000000,0.384320000000000,0.392050000000000,0.377960000000000,0.372070000000000,0.382010000000000;0.249170000000000,0.298740000000000,0.313100000000000,0.323680000000000,0.338430000000000,0.361350000000000,0.393080000000000,0.435810000000000,0.486380000000000,0.517370000000000,0.536880000000000,0.539700000000000,0.532220000000000,0.515240000000000,0.487890000000000,0.452810000000000,0.413080000000000,0.369620000000000,0.330830000000000,0.290960000000000,0.253540000000000,0.217810000000000,0.196040000000000,0.182930000000000,0.171120000000000,0.163460000000000,0.159590000000000,0.161990000000000,0.168940000000000,0.177300000000000,0.184980000000000;0.0476500000000000,0.0401800000000000,0.0418400000000000,0.0477500000000000,0.0511900000000000,0.0573400000000000,0.0618900000000000,0.0669100000000000,0.0715800000000000,0.0801500000000000,0.0907900000000000,0.0968600000000000,0.112150000000000,0.138090000000000,0.163650000000000,0.190340000000000,0.246380000000000,0.315950000000000,0.392060000000000,0.487230000000000,0.541020000000000,0.559000000000000,0.569960000000000,0.577560000000000,0.583300000000000,0.590350000000000,0.593870000000000,0.593370000000000,0.593680000000000,0.591030000000000,0.590670000000000;0.269800000000000,0.338390000000000,0.364770000000000,0.382590000000000,0.389750000000000,0.384750000000000,0.361920000000000,0.333220000000000,0.284500000000000,0.241210000000000,0.202710000000000,0.165850000000000,0.130900000000000,0.101100000000000,0.0911400000000000,0.0835300000000000,0.0779400000000000,0.0761100000000000,0.0741000000000000,0.0803400000000000,0.0827300000000000,0.0764600000000000,0.0706800000000000,0.0671400000000000,0.0731600000000000,0.0931800000000000,0.118130000000000,0.140940000000000,0.160980000000000,0.169420000000000,0.179450000000000;0.111610000000000,0.104390000000000,0.106680000000000,0.110230000000000,0.113540000000000,0.118370000000000,0.118320000000000,0.115850000000000,0.108350000000000,0.105690000000000,0.102000000000000,0.0964400000000000,0.0904400000000000,0.0893800000000000,0.0906100000000000,0.0859200000000000,0.0885200000000000,0.0988600000000000,0.146150000000000,0.253860000000000,0.380480000000000,0.475930000000000,0.538150000000000,0.564340000000000,0.572260000000000,0.573710000000000,0.570900000000000,0.565040000000000,0.564840000000000,0.564920000000000,0.576930000000000;0.152110000000000,0.160960000000000,0.158000000000000,0.148600000000000,0.138150000000000,0.125690000000000,0.115060000000000,0.106720000000000,0.0959100000000000,0.0814000000000000,0.0711900000000000,0.0635600000000000,0.0518700000000000,0.0467500000000000,0.0474100000000000,0.0466100000000000,0.0445300000000000,0.0383600000000000,0.0412900000000000,0.0478400000000000,0.0585100000000000,0.0790700000000000,0.0986800000000000,0.117290000000000,0.138680000000000,0.171760000000000,0.211940000000000,0.252150000000000,0.283490000000000,0.302050000000000,0.325700000000000;0.0621400000000000,0.0555600000000000,0.0569100000000000,0.0599000000000000,0.0706400000000000,0.0817300000000000,0.0934900000000000,0.103750000000000,0.128750000000000,0.159960000000000,0.222870000000000,0.311880000000000,0.425580000000000,0.521230000000000,0.556510000000000,0.548970000000000,0.521920000000000,0.482380000000000,0.439900000000000,0.396430000000000,0.357910000000000,0.328850000000000,0.310360000000000,0.302400000000000,0.294270000000000,0.290920000000000,0.292980000000000,0.301110000000000,0.318260000000000,0.333260000000000,0.352060000000000;0.0643400000000000,0.0519000000000000,0.0514100000000000,0.0547200000000000,0.0581200000000000,0.0654600000000000,0.0711900000000000,0.0755000000000000,0.0761200000000000,0.0799600000000000,0.0988800000000000,0.134380000000000,0.198710000000000,0.284370000000000,0.359260000000000,0.408350000000000,0.436580000000000,0.461710000000000,0.503630000000000,0.552210000000000,0.581800000000000,0.600190000000000,0.610890000000000,0.619840000000000,0.627570000000000,0.635320000000000,0.641610000000000,0.642940000000000,0.649040000000000,0.651710000000000,0.658480000000000;0.151860000000000,0.187470000000000,0.203220000000000,0.227030000000000,0.257430000000000,0.275080000000000,0.266100000000000,0.245640000000000,0.201960000000000,0.159900000000000,0.125960000000000,0.100680000000000,0.0759400000000000,0.0533400000000000,0.0420600000000000,0.0380600000000000,0.0365900000000000,0.0386600000000000,0.0400300000000000,0.0437500000000000,0.0469800000000000,0.0434400000000000,0.0405700000000000,0.0407800000000000,0.0457200000000000,0.0578100000000000,0.0709000000000000,0.0753500000000000,0.0786500000000000,0.0762400000000000,0.0760500000000000;0.0486700000000000,0.0442300000000000,0.0476200000000000,0.0524700000000000,0.0633200000000000,0.0748700000000000,0.0840500000000000,0.0935000000000000,0.112940000000000,0.140150000000000,0.192940000000000,0.268100000000000,0.325080000000000,0.346950000000000,0.332480000000000,0.298760000000000,0.258660000000000,0.216290000000000,0.178960000000000,0.148750000000000,0.123360000000000,0.106920000000000,0.0979600000000000,0.0941300000000000,0.0908500000000000,0.0882100000000000,0.0880100000000000,0.0903000000000000,0.0980400000000000,0.105910000000000,0.115310000000000;0.0325600000000000,0.0214400000000000,0.0236800000000000,0.0333600000000000,0.0407600000000000,0.0475900000000000,0.0526200000000000,0.0537800000000000,0.0550300000000000,0.0532600000000000,0.0536600000000000,0.0539600000000000,0.0532600000000000,0.0495000000000000,0.0473700000000000,0.0454400000000000,0.0509700000000000,0.0553000000000000,0.0685100000000000,0.121370000000000,0.207770000000000,0.322680000000000,0.440830000000000,0.503810000000000,0.533610000000000,0.556160000000000,0.576090000000000,0.593670000000000,0.614480000000000,0.628090000000000,0.650160000000000;0.0497900000000000,0.0422800000000000,0.0432200000000000,0.0487600000000000,0.0570700000000000,0.0653100000000000,0.0705600000000000,0.0743300000000000,0.0878900000000000,0.118220000000000,0.196750000000000,0.308980000000000,0.434660000000000,0.534150000000000,0.582880000000000,0.606450000000000,0.622620000000000,0.634490000000000,0.646200000000000,0.659020000000000,0.668450000000000,0.676550000000000,0.678760000000000,0.687630000000000,0.690540000000000,0.692790000000000,0.695780000000000,0.694240000000000,0.694920000000000,0.695480000000000,0.702850000000000;0.287080000000000,0.349900000000000,0.354350000000000,0.341690000000000,0.320910000000000,0.299170000000000,0.268020000000000,0.248210000000000,0.214780000000000,0.185880000000000,0.168260000000000,0.148200000000000,0.122830000000000,0.0996600000000000,0.0962700000000000,0.0984100000000000,0.0976400000000000,0.0949800000000000,0.120180000000000,0.199710000000000,0.315760000000000,0.420480000000000,0.494770000000000,0.547000000000000,0.595770000000000,0.655140000000000,0.703470000000000,0.732150000000000,0.747040000000000,0.750310000000000,0.760730000000000;0.198620000000000,0.235410000000000,0.253880000000000,0.273440000000000,0.301650000000000,0.329530000000000,0.359630000000000,0.392950000000000,0.415360000000000,0.418570000000000,0.403560000000000,0.366080000000000,0.314230000000000,0.258640000000000,0.211540000000000,0.166700000000000,0.132170000000000,0.108360000000000,0.0947300000000000,0.0862600000000000,0.0822700000000000,0.0737700000000000,0.0708100000000000,0.0680200000000000,0.0665000000000000,0.0684700000000000,0.0686600000000000,0.0713400000000000,0.0731800000000000,0.0728300000000000,0.0719000000000000;0.426880000000000,0.660230000000000,0.758700000000000,0.776570000000000,0.788480000000000,0.796450000000000,0.805170000000000,0.814900000000000,0.824030000000000,0.830350000000000,0.834060000000000,0.835080000000000,0.837100000000000,0.838000000000000,0.839970000000000,0.840560000000000,0.843810000000000,0.842240000000000,0.837220000000000,0.840170000000000,0.844410000000000,0.845750000000000,0.845170000000000,0.847080000000000,0.847450000000000,0.850370000000000,0.853740000000000,0.854070000000000,0.853610000000000,0.853670000000000,0.853330000000000;0.381460000000000,0.515050000000000,0.546620000000000,0.549290000000000,0.553100000000000,0.555260000000000,0.556880000000000,0.560250000000000,0.559430000000000,0.558830000000000,0.559540000000000,0.559080000000000,0.560360000000000,0.559200000000000,0.558330000000000,0.557590000000000,0.558270000000000,0.556310000000000,0.553680000000000,0.553640000000000,0.552650000000000,0.549110000000000,0.546930000000000,0.545950000000000,0.544090000000000,0.544900000000000,0.545360000000000,0.542140000000000,0.540340000000000,0.535660000000000,0.531990000000000;0.278010000000000,0.330660000000000,0.340690000000000,0.342890000000000,0.346460000000000,0.348270000000000,0.348440000000000,0.348710000000000,0.345970000000000,0.344660000000000,0.344790000000000,0.346400000000000,0.347580000000000,0.347360000000000,0.346550000000000,0.346180000000000,0.348650000000000,0.348600000000000,0.346850000000000,0.347380000000000,0.346030000000000,0.342420000000000,0.339100000000000,0.336510000000000,0.332950000000000,0.331380000000000,0.330010000000000,0.326030000000000,0.323930000000000,0.320290000000000,0.317310000000000;0.163090000000000,0.176900000000000,0.180190000000000,0.181750000000000,0.184630000000000,0.186640000000000,0.186420000000000,0.185710000000000,0.183640000000000,0.182540000000000,0.183160000000000,0.184520000000000,0.184830000000000,0.184880000000000,0.184870000000000,0.184540000000000,0.186910000000000,0.187730000000000,0.186750000000000,0.186970000000000,0.186470000000000,0.184640000000000,0.182770000000000,0.181010000000000,0.178530000000000,0.177530000000000,0.175750000000000,0.172820000000000,0.170770000000000,0.167950000000000,0.166090000000000;0.0875000000000000,0.0904000000000000,0.0906400000000000,0.0912000000000000,0.0925800000000000,0.0935800000000000,0.0933100000000000,0.0922600000000000,0.0920400000000000,0.0916600000000000,0.0918400000000000,0.0926800000000000,0.0923600000000000,0.0924100000000000,0.0915500000000000,0.0907700000000000,0.0912400000000000,0.0911400000000000,0.0905700000000000,0.0915300000000000,0.0919900000000000,0.0900800000000000,0.0885700000000000,0.0875200000000000,0.0867000000000000,0.0869400000000000,0.0856400000000000,0.0847700000000000,0.0833900000000000,0.0815000000000000,0.0805400000000000;0.0317000000000000,0.0316800000000000,0.0313500000000000,0.0307500000000000,0.0318200000000000,0.0324000000000000,0.0332500000000000,0.0340200000000000,0.0331800000000000,0.0334700000000000,0.0326300000000000,0.0319200000000000,0.0318500000000000,0.0322400000000000,0.0322300000000000,0.0316800000000000,0.0326000000000000,0.0326300000000000,0.0330500000000000,0.0332300000000000,0.0332700000000000,0.0328200000000000,0.0331300000000000,0.0335400000000000,0.0331600000000000,0.0334800000000000,0.0325800000000000,0.0319800000000000,0.0319800000000000,0.0324700000000000,0.0326700000000000]';
    
    lambda_est = 420 : 5 : 660;
    SPD_est = [0.0402146229855171,0.119491159484011,0.176505057494375,0.0432361726253870,0.251873362476750,0.168784070876971,0.0270302729048301,0.232216211666033,0.0882457090032708,0.108359840239946,0.0479628885785875,0.0372203523213137,0.125493340300251,0.0449004204752178,0.0338372986703191,0.0406443244358081,0.215457855104686,0.137429504493565,0.383423441544575,0.312311232601609,0.197103448132674,0.104908589149785,0.0556429567324916,0.0141528688839349;0.0417784298464405,0.123590235375255,0.195565669640140,0.0450439284967277,0.269024555093714,0.188230849997348,0.0294577694929057,0.254287157923096,0.0925977072961199,0.110153267611637,0.0466154106669679,0.0388504065960775,0.142784971575338,0.0442026662343061,0.0366080335896833,0.0389956299029111,0.222456216256466,0.162665228707739,0.425712548114382,0.338438756047836,0.214544693183399,0.113514297379990,0.0604317942166591,0.0166928998642511;0.0432716969720833,0.128118500242878,0.212231896407428,0.0468975203530433,0.283790166871507,0.207043529701877,0.0318471476145726,0.272803269967918,0.0963499261134526,0.111318773311230,0.0466482076542631,0.0406687514096832,0.157486457888076,0.0445148608773650,0.0391218757745974,0.0385346318813904,0.227782079061704,0.185802063532970,0.463879580263324,0.361827628214909,0.230166586686823,0.121241914160281,0.0647034813365502,0.0190001053682154;0.0446944243624454,0.133075954086881,0.226503737796241,0.0487969481943338,0.296170197810128,0.225222109990559,0.0341984072698308,0.287764547800500,0.0995023654552691,0.111856357338724,0.0480612795404729,0.0426753867621310,0.169597799238466,0.0458370044043945,0.0413788252250614,0.0392613303712460,0.231435443520401,0.206840008969256,0.497924537991401,0.382477849102828,0.243969128642945,0.128091439490658,0.0684580180921649,0.0210744853958278;0.0460466120175269,0.138462596907262,0.238381193806577,0.0507422120205992,0.306164647909578,0.242766590863394,0.0365115484586803,0.299170991420842,0.102055025321569,0.111766019694121,0.0508546263255973,0.0448703126534208,0.179118995626509,0.0481690968153947,0.0433788819410753,0.0411757253724779,0.233416309632556,0.225779065016598,0.527847421298613,0.400389418711592,0.255952319051766,0.134062873371123,0.0716954044835032,0.0229160399470882;0.0473282599373278,0.144278428704023,0.247864264438438,0.0527333118318394,0.313773517169856,0.259676972320382,0.0387865711811210,0.307022600828942,0.104007905712353,0.111047760377420,0.0550282480096365,0.0472535290835526,0.186050047052203,0.0515111381103655,0.0451220459226391,0.0442778168850861,0.233724677398168,0.242619231674996,0.553648230184960,0.415562337041202,0.266116157913286,0.139156215801673,0.0744156405105652,0.0245247690219967;0.0485393681218480,0.150523449477162,0.254952949691822,0.0547702476280546,0.318996805590964,0.275953254361522,0.0410234754371530,0.311319376024802,0.105361006627621,0.109701579388621,0.0605821445925902,0.0498250360525265,0.190390953515549,0.0558631282893069,0.0466083171697527,0.0485676049090705,0.232360546817239,0.257360508944450,0.575326964650441,0.427996604091658,0.274460645227504,0.143371466782310,0.0766187261733508,0.0259006726205533;0.0496799365710876,0.157197659226681,0.259647249566731,0.0568530194092446,0.321834513172900,0.291595436986814,0.0432222612267763,0.312061317008422,0.106114328067372,0.107727476727723,0.0675163160744587,0.0525848335603423,0.192141715016548,0.0612250673522191,0.0478376956824162,0.0540450894444313,0.229323917889769,0.270002896824959,0.592883624695057,0.437692219862960,0.280985780994421,0.146708626313033,0.0783046614718600,0.0270437507427579;0.0507499652850466,0.164301057952579,0.261947164063163,0.0589816271754096,0.322286639915665,0.306603520196260,0.0453829285499909,0.309248423779800,0.106267870031607,0.105125452394728,0.0758307624552418,0.0555329216070002,0.191302331555198,0.0675969552991018,0.0488101814606296,0.0607102704911683,0.224614790615756,0.280546395316525,0.606318210318809,0.444649184355108,0.285691565214037,0.149167694393843,0.0794734464060928,0.0279540033886106;0.0517519145637119,0.172959448278208,0.260784702866217,0.0609310439081746,0.319236017412633,0.321722388119542,0.0472333510042252,0.300899986470604,0.105522299966111,0.101468254348771,0.0854608306563569,0.0577183860913083,0.186460503129770,0.0754941746434963,0.0494120952647197,0.0677041795873146,0.217205810556917,0.289075977733290,0.613777750152712,0.447508796085386,0.287719831583237,0.150345788674833,0.0798673646016885,0.0285332702336274;0.0526868388213637,0.183655317042146,0.255702155840935,0.0626048294568076,0.312203859203823,0.337271276812242,0.0486569029883770,0.286167129422973,0.103749332490505,0.0965727745723393,0.0963788122155542,0.0587336923984701,0.177010958310952,0.0851376036054917,0.0495947174205408,0.0746586873920271,0.206656682953986,0.295628061209888,0.614468113610060,0.445688754418344,0.286702794543544,0.150070245291757,0.0793759661839210,0.0287394825673150;0.0535526292294417,0.195423690567236,0.247614943257233,0.0641958641227727,0.302147738209198,0.352611714163200,0.0498868357046507,0.266747603952625,0.101205538365546,0.0908052291004592,0.108640124057333,0.0593939097580786,0.164164239957370,0.0960854857449097,0.0494554872763842,0.0823100525869918,0.193847997325494,0.300129811477052,0.609977561864268,0.440353660624882,0.283376025211912,0.148686391973106,0.0782201509022424,0.0286567778106598;0.0543471769593857,0.207299595176319,0.237438485385026,0.0658970282075341,0.290025227348724,0.367105228061257,0.0511564003552504,0.244339161375275,0.0981474883519886,0.0845318339681563,0.122300183106193,0.0605141073997268,0.149130890927647,0.107896064621572,0.0490918441805412,0.0913945338538948,0.179660343189970,0.302508394265517,0.601894356088748,0.432668115975899,0.278475094705298,0.146539556447373,0.0766208185061048,0.0283692933846480;0.0550683731826353,0.218318057192236,0.226088202494232,0.0679012020125559,0.276793899542364,0.380113346395256,0.0526988481423803,0.220639553006639,0.0948317532105898,0.0781188052104566,0.137414406286634,0.0629093545530076,0.133121454080410,0.120127583795302,0.0486012274813033,0.102648389874422,0.164974310065944,0.302690975306016,0.591806757456914,0.423796721742294,0.272735574140656,0.143975066443047,0.0747988687449602,0.0279611667102662;0.0557141090706304,0.227514102937829,0.214479514854766,0.0704012658393022,0.263411327710084,0.390997597054038,0.0547474302682446,0.197346530162432,0.0915149037021052,0.0719323588623861,0.154038210523155,0.0673947204475141,0.117346472274285,0.132338286825919,0.0480810765269617,0.116807879330260,0.150670487471945,0.300604720329284,0.581303027142181,0.414904079194966,0.266893034634941,0.141338249688622,0.0729752013682608,0.0275165352085004;0.0562822757948107,0.233922758735940,0.203527842736545,0.0735900999892372,0.250835084771847,0.399119507926444,0.0575353979350476,0.176157844158369,0.0884535105872906,0.0663387109589706,0.172227012740255,0.0747852743128392,0.103016488367896,0.144086417273247,0.0476288306658077,0.134609260903094,0.137629464926503,0.296176795066053,0.571971426317962,0.407154789604814,0.261683047305109,0.138974433912587,0.0713707161254586,0.0271195363003372;0.0567707645266159,0.236579050909410,0.194148606409485,0.0776605847638249,0.240022743647618,0.403840606901316,0.0612960023449935,0.158771246310168,0.0859041446269020,0.0617040775352360,0.192036229862434,0.0858960853785759,0.0913420452198684,0.154930218697107,0.0473419292461327,0.156788793274611,0.126731831948147,0.289334365247058,0.565400216157671,0.401713454242738,0.257841183268115,0.137228946843435,0.0702063127660057,0.0268543074067627;0.0570544920062861,0.234408913113433,0.185678164985814,0.0834206738129216,0.230513882353621,0.405022343649906,0.0655128468393640,0.144267252017237,0.0834905051089085,0.0578998615506326,0.216177148157198,0.102168245408008,0.0816254695385517,0.166258259796609,0.0471466878943628,0.186379057846240,0.117340068076205,0.278746480422270,0.560921419261142,0.398327523845427,0.255027772406873,0.135937970741215,0.0693905953881811,0.0266963321010279;0.0570818595306482,0.227871053749912,0.176960272113710,0.0910329374612616,0.221199202973036,0.403213408137188,0.0697424745623234,0.130634890435785,0.0808069671941008,0.0545221728115668,0.245758969430145,0.123443108747693,0.0724148605240710,0.179086361862018,0.0469187282139270,0.223978533616989,0.108342293571788,0.263912099226693,0.556736129910766,0.395779618946798,0.252396697893154,0.134702414452145,0.0686740136060547,0.0265549724659677;0.0569609851060223,0.218299661261747,0.168171439867013,0.0997221810226264,0.212062964526255,0.398806188692585,0.0743275464204000,0.117934683516727,0.0780661154524671,0.0515242876234986,0.278433983912913,0.148136138502133,0.0637894197727164,0.192413647339888,0.0466794485186209,0.266672325664909,0.0999075590361032,0.246003251018608,0.552736216803794,0.393787095513588,0.249923860777191,0.133514695583974,0.0680402354427651,0.0264151836869443;0.0567999867387285,0.207028924091839,0.159488180319563,0.108713209810798,0.203089426033673,0.392193073645519,0.0796107233201218,0.106227153210973,0.0754805344539956,0.0488594822918882,0.311854481837140,0.174662797775831,0.0558283488807781,0.205239238676771,0.0464502471222401,0.311545539068052,0.0922049150703580,0.226191965156296,0.548813548637477,0.392067309512534,0.247585162109218,0.132367231744449,0.0674729289214509,0.0262619209493199;0.0567069824350867,0.195393030683088,0.151087005545200,0.117230829139557,0.194262846515683,0.383766451325414,0.0859346661680169,0.0955728214694382,0.0732628087686745,0.0464810331221958,0.343672753434465,0.201438549673288,0.0486108494445461,0.216562258319220,0.0462525223385801,0.355683278904470,0.0854034122757601,0.205650270998038,0.544859994109067,0.390337616910373,0.245356502939470,0.131252440541317,0.0669557620652506,0.0260801394384567;0.0567900902014171,0.184726169478395,0.143144427617765,0.124499844322686,0.185567484992679,0.373918710061693,0.0936420358706135,0.0860322102430346,0.0716255229664920,0.0443422164198814,0.371541088936525,0.226878857299007,0.0422161230603106,0.225381828713789,0.0461076724814367,0.396170650252214,0.0796721012535168,0.185550197902116,0.540767421915814,0.388315373673842,0.243213784318182,0.130162739582327,0.0664724028973028,0.0258547943397169;0.0571574280440398,0.176362528920662,0.135836958611097,0.129745060673966,0.176987600485055,0.363042238183778,0.103075493334440,0.0776658414826753,0.0707812616174363,0.0423963084904052,0.393111778574959,0.249399183757491,0.0367233713243616,0.230697072307031,0.0460370958646054,0.430092758189337,0.0751800326048357,0.167063775226811,0.536427700754968,0.385717935769679,0.241132907295586,0.129090546475226,0.0660065194407462,0.0255708408384626;0.0579171139692747,0.171636297452789,0.129341110599037,0.132191283507178,0.168507452013204,0.351529424021093,0.114577699466023,0.0705342371392733,0.0709426092914956,0.0405965856392272,0.406037112581405,0.267414992153243,0.0322117958329893,0.231507111545500,0.0460621908018819,0.454534707793890,0.0720962569309242,0.151363032330404,0.531732699323782,0.382262659164620,0.239089772921918,0.128028278827761,0.0655417797187193,0.0252132341200561;0.0591461898979794,0.169929767040768,0.123698585980266,0.131450023753922,0.159346394120926,0.338363040580191,0.129151080148247,0.0650404361258111,0.0708042949151652,0.0387996693834483,0.409622874654324,0.281027349415730,0.0290142650702351,0.226817530714151,0.0446265290512403,0.469146561331014,0.0694710887361895,0.137855633407045,0.526650702072893,0.377843305350895,0.237253688071117,0.127048148381801,0.0651282157954423,0.0247268765994161;0.0607747042664072,0.169707550010117,0.118759150474369,0.128093066752708,0.149184855878996,0.322733430264432,0.146898902753270,0.0612995294517453,0.0696044551045733,0.0369886105585304,0.405807457586734,0.291788652700916,0.0271980068661262,0.217155368366963,0.0410426905910551,0.476554435887622,0.0667365193785131,0.125171501817769,0.521271098817099,0.372683528333041,0.235720164212741,0.126188324352674,0.0648028242478302,0.0241024834206866;0.0626902848539715,0.170927315343029,0.114411411136548,0.122785629427690,0.138698708098276,0.305344335498445,0.166815090421540,0.0589401172126994,0.0683707859641575,0.0353063294474757,0.396192065252109,0.300291360453038,0.0264437618359314,0.203801928354023,0.0366355860657213,0.478307518774432,0.0646341147393144,0.113316055671183,0.515667416299887,0.366995522846261,0.234354409290459,0.125390160558314,0.0645297198680633,0.0233937288630678;0.0647805594400857,0.173546732021698,0.110543975022000,0.116192928703020,0.128563821589627,0.286899498706859,0.187893566293503,0.0575907995042971,0.0681309835983556,0.0338957463332866,0.382377901523924,0.307127931116336,0.0264322705949192,0.188038514525415,0.0327301261196343,0.475954997302156,0.0639054407000126,0.102294713075895,0.509913181264745,0.360991483625758,0.233021631247936,0.124595010816656,0.0642730174483218,0.0226542872057598;0.0669331558041636,0.177523469028316,0.107045449185926,0.108980181502849,0.119456067163910,0.268102662314303,0.209128253509606,0.0568801764221619,0.0699127441116054,0.0328997814989652,0.365966170275653,0.312890823135050,0.0268442737583585,0.171146430731226,0.0306512213971894,0.471046058781512,0.0652920631420270,0.0921128921405157,0.504081920455161,0.354883605406735,0.231587038028838,0.123744228945635,0.0639968317807862,0.0219378327279628;0.0690357017256185,0.182815195345076,0.103804440683523,0.101812604751330,0.112051315631986,0.249657568745407,0.229513075210294,0.0564368480619176,0.0747437636083447,0.0324613552275137,0.348558075380771,0.318172494953418,0.0273605119415179,0.154406980821540,0.0317237825427819,0.465129890523213,0.0695355479467770,0.0827760109736520,0.498247160614621,0.348884082924394,0.229915837576833,0.122779168763186,0.0636652776576367,0.0212980397088770;0.0709758249838640,0.189379579954171,0.100709556569992,0.0953554153726154,0.107025437804718,0.232267960424800,0.248041954536014,0.0558894145191876,0.0836517381930110,0.0327233878019344,0.331754820712752,0.323565405015680,0.0276617257596661,0.139101468646444,0.0372727202008072,0.459755679837975,0.0773774609956819,0.0742894876839127,0.492482428486615,0.343205110913938,0.227873237835587,0.121641184087244,0.0632424698710538,0.0207885824277025;0.0726411533583136,0.197174291837794,0.0976494039005308,0.0902738302908576,0.105054304492965,0.216637579777111,0.263708814627213,0.0548664758895957,0.0976643639700423,0.0338287995052295,0.317157610145072,0.329662011766076,0.0274286558280719,0.126511198056024,0.0486229450156604,0.456472614036512,0.0895593681701609,0.0666587403799065,0.486861250814629,0.338058884110569,0.225324446748766,0.120271628735743,0.0626925232132175,0.0204631351636394;0.0741079855784067,0.207525113105776,0.0946244707472890,0.0862012804390826,0.106756097492951,0.202195810192586,0.277198669192396,0.0534796564393922,0.119562106831737,0.0358409809965482,0.303184635373328,0.336627591178452,0.0267702364404362,0.115832348581436,0.0678734496912232,0.454398394504927,0.108090069950378,0.0600264926059195,0.481332655036465,0.333397559388792,0.222100482865529,0.118593218866111,0.0619229044167297,0.0203786177636279;0.0755160422620804,0.221040551345955,0.0917410548029021,0.0823471248608235,0.111752065373666,0.188027870815016,0.289763263972876,0.0521305093344716,0.149557836822950,0.0386509851459998,0.287633022482801,0.343968729675656,0.0260372102795180,0.105500136355001,0.0946619828678305,0.451679476779440,0.133124227607432,0.0544487514917807,0.475804770298334,0.328998542327961,0.218257298951070,0.116628686338259,0.0609281327553904,0.0205083060866419;0.0768480840214954,0.236602363757537,0.0890464775533004,0.0787404726459924,0.119222679105121,0.174321257699350,0.301246620158317,0.0508825280199233,0.184827856276952,0.0421432255530271,0.271172376931491,0.351289851375432,0.0252730305441726,0.0956544201285452,0.126621589094557,0.448408179395943,0.162622198209147,0.0498008605244125,0.470289775906341,0.324811900720559,0.213997504273112,0.114469408523850,0.0598029018331784,0.0207804084299329;0.0780868714688121,0.253092307539727,0.0865880604844139,0.0754104328845015,0.128348409657326,0.161263466900536,0.311492758938380,0.0497992059408368,0.222548467527012,0.0462021158170726,0.254472304177393,0.358195380395524,0.0245211504332553,0.0864350586538985,0.161385312920478,0.444676820890326,0.194544338823344,0.0459581631907372,0.464799851166590,0.320787702359067,0.209523708099376,0.112206762794545,0.0586419052540721,0.0211231330907523;0.0792151652161911,0.269392139891731,0.0844131250821726,0.0723861146662630,0.138309728000294,0.149041994473523,0.320345701502726,0.0489440365423017,0.259895972906401,0.0507120695375789,0.238202409678505,0.364289740853675,0.0238250231456215,0.0779819106828888,0.196586198894667,0.440577719798483,0.226851006517847,0.0427960029776772,0.459347175385187,0.316876015035967,0.205038519697582,0.109932126522005,0.0575398366220502,0.0214646883663513;0.0802157258757930,0.284383618012754,0.0825689928325066,0.0696966270811891,0.148287105104035,0.137844336473259,0.327649469041018,0.0483805132694074,0.294046674748390,0.0555575003139888,0.223032298892825,0.369177356867628,0.0232281018801265,0.0704348349673444,0.229857291566201,0.436203194656304,0.257502558360479,0.0401897233721548,0.453943927868236,0.313026906543741,0.200744548335453,0.107736877077893,0.0565913895410912,0.0217332825539814;0.0810713140597782,0.296948499102002,0.0811029852213461,0.0673710792191919,0.157461011938561,0.127857988954693,0.333248082742917,0.0481721295672435,0.322176875386250,0.0606228217457449,0.209631577278351,0.372462652555128,0.0227738398356258,0.0639336902590936,0.258831635484153,0.431645563999683,0.284459351419061,0.0380146678610924,0.448602287921841,0.309190444674870,0.196844403280709,0.105712391833870,0.0558912576151737,0.0218571239508939;0.0817646903803072,0.305968540358679,0.0800624237346210,0.0654385801701836,0.165011919473884,0.119270447972774,0.336985563798085,0.0483823788808995,0.341462877153249,0.0657924474322898,0.198669850293079,0.373750052033916,0.0225056902109747,0.0586183353099648,0.281142275197598,0.426997146364509,0.305681742761417,0.0361461799314124,0.443334434852107,0.305316697221837,0.193540693801072,0.103950048161598,0.0555341344482763,0.0217644208543401;0.0823044745312999,0.312002863183184,0.0794236476293665,0.0638845753892082,0.171349592224997,0.111987965500026,0.338939901611690,0.0489795144878306,0.353316528882755,0.0711241705739022,0.189812315208011,0.373237343245123,0.0224019264067455,0.0544188407440438,0.297972688432000,0.422211782482838,0.322189553853636,0.0346465878396535,0.438134279005982,0.301430630288400,0.190732115262681,0.102404157375246,0.0554726732384097,0.0214910691156944;0.0827107791319023,0.316356084176442,0.0791314485053306,0.0626751042713680,0.177430147393554,0.105791796139011,0.339293071462462,0.0498894607020991,0.361032144519283,0.0767528419712323,0.182277765655483,0.371386031384713,0.0224118530242737,0.0511720380175309,0.312084323213438,0.417181767396130,0.336362368116590,0.0336613241844064,0.432987611193010,0.297590498116664,0.188182290186528,0.100968112541209,0.0555963981142655,0.0211208257214968;0.0829836041821143,0.319028203338455,0.0791858263625134,0.0618101668166632,0.183253584979554,0.100681939889728,0.338045073350400,0.0511122175237050,0.364609724062834,0.0826784616242801,0.176066201635496,0.368196116452687,0.0225354700635591,0.0488779271304261,0.323477179541910,0.411907101104383,0.348200185550280,0.0331903889656710,0.427894431413192,0.293796300706629,0.185891218572613,0.0996419136594861,0.0559053090758438,0.0206536906717474;0.0831229496819361,0.320019220669223,0.0795867812009149,0.0612897630250936,0.188819904982999,0.0966583967521774,0.335195907275504,0.0526477849526482,0.364049267513409,0.0889010295330457,0.171177623148049,0.363667598449044,0.0227727775246019,0.0475365080827293,0.332151257417418,0.406387783607598,0.357703006154707,0.0332337821834474,0.422854739666526,0.290048038058295,0.183858900420936,0.0984255607300782,0.0563994061231445,0.0200896639664462;0.0831288156313674,0.319329136168744,0.0803343130205351,0.0611138928966593,0.194129107403888,0.0937211667263587,0.330745573237774,0.0544961629889289,0.359350774871007,0.0954205456975290,0.167612030193142,0.357800477373785,0.0231237754074020,0.0471477808744406,0.338106556839962,0.400623814905776,0.364870829929869,0.0337915038377355,0.417868535953015,0.286345710171662,0.182085335731497,0.0973190537529849,0.0570786892561677,0.0194287456055931;0.0830012020304085,0.316957949837020,0.0814284218213740,0.0612825564313603,0.199181192242221,0.0918702498122723,0.324694071237210,0.0566573516325468,0.350514246135628,0.102237010117730,0.165369422770776,0.350594753226910,0.0235884637119594,0.0477117455055601,0.341343077809541,0.394615194998915,0.369703656875767,0.0348635539285353,0.412935820272656,0.282689317046730,0.180570524504296,0.0963223927282064,0.0579431584749133,0.0186709355891882;0.0827401088790592,0.312905661674050,0.0828691076034316,0.0617957536291967,0.203976159497998,0.0911056460099179,0.317041401273812,0.0591313508835022,0.337539681307272,0.109350422793649,0.164449800880949,0.342050426008418,0.0241668424382742,0.0492284019760876,0.341860820326156,0.388361923887017,0.372201486992400,0.0364499324558470,0.408056592625451,0.279078858683499,0.179314466739333,0.0954355776557425,0.0589928137793814,0.0178162339172314;0.0823455361773195,0.307172271679834,0.0846563703667080,0.0626534844901682,0.208514009171219,0.0914273553192958,0.307787563347580,0.0619181607417949,0.320427080385939,0.116760783725286,0.164853164523663,0.332167495718310,0.0248589115863462,0.0516977502860232,0.339659784389806,0.381864001570081,0.372364320279770,0.0385506394196703,0.403230853011400,0.275514335081969,0.178317162436608,0.0946586085355933,0.0602276551695719,0.0168646405897227];
    
    %% Basic inputs
    
    Observer.path = 'C:\Users\Admin\Desktop\PAINTERS_COPILOT';
    Observer.filename = 'ciexyz31.csv';
    Observer.source = 'http://cvrl.ioo.ucl.ac.uk/index.htm';
    Observer.description = 'Observer color matching functions: CIE 1931 2-deg';

    Illuminant.path = 'C:\Users\Admin\Desktop\PAINTERS_COPILOT';
    Illuminant.filename = 'illuminantd65.csv';
    Illuminant.source = 'http://cvrl.ioo.ucl.ac.uk/index.htm';
    Illuminant.description = 'Illuminant D65: average midday light in Western/Northern Europe';
    
    % Observer
    O = csvread([Observer.path '\' Observer.filename]);
    Observer.lambda = O(:,1);
    Observer.responses = O(:,2:end);
    Observer.Lab_JND = 2.3; % "just noticeable difference" in CIE76 color difference; source: https://en.wikipedia.org/wiki/Color_difference
    Observer.grayscale_weights = [0.21 0.72 0.07]; % RGB luminosity weighting
    
    % Illuminant
    I = csvread([Illuminant.path '\' Illuminant.filename]);
    Illuminant.lambda = I(:,1);
    Illuminant.power  = I(:,2);
    Illuminant.power = interp1(Illuminant.lambda,Illuminant.power,Observer.lambda); % Re-sample to match Observer
    Illuminant.power = Illuminant.power ./ max(Illuminant.power); % normalize 0-1
    Illuminant.lambda = Observer.lambda;
    
    %% Align curves with scalar gain using bisection method
    
    I_gain = interp1(Illuminant.lambda, Illuminant.power, lambda_act)';
    qty = size(R_act,2);
        
    ERR = [];
    Y_ACT = [];
    Y_EST = [];
   
    Gain_Lims = [0.1 10];
    Gain_Lims_prev = Gain_Lims;
    
    delta = Inf;
    
    % Resample measurements to match estimation domain
    for s = 1 : qty
        SPD_act(:,s) = interp1(lambda_act, R_act(:,s).*I_gain, lambda_est)';
    end
    
    while delta > 0.0001
        
        Act = SPD_act;
        Est = SPD_est .* mean(Gain_Lims);
        
        Err = Est - Act;
        
        [undershoot, ~] = min(Err(:));
        [overshoot,  ~] = max(Err(:));
        
        if sum(Err(:)) < 0 % sum(Err(:)) = 0
%         if abs(undershoot) > abs(overshoot) % overshoot = undershoot
            Gain_Lims(1) = mean(Gain_Lims);
        else
            Gain_Lims(2) = mean(Gain_Lims);
        end
        
        delta = abs(mean(Gain_Lims_prev) - mean(Gain_Lims));
        Gain_Lims_prev = Gain_Lims;
        
    end
    
    GAIN = mean(Gain_Lims);
    SPD_est = SPD_est .* GAIN;
    disp(['Applied gain of ' num2str(GAIN) ' to SPD_est for curve alignment'])
    
    %% Evaulate actual vs. estimated colors
    
    % Initialize color matrices
    XYZ_act = zeros(qty,3);
    XYZ_est = zeros(qty,3);
    RGB_act = zeros(qty,3);
    RGB_est = zeros(qty,3);
    Lab_act = zeros(qty,3);
    Lab_est = zeros(qty,3);
    
    dE = zeros(qty,1); % color difference
    
    % Generate tristimulus values
    % Per http://www.brucelindbloom.com/index.html?Eqn_Spect_to_XYZ.html
    
    for s = 1 : qty
        
        for cc = 1 : 3
            
            % Actual measured color
            d_lambda = abs(mean(diff(lambda_act)));
            O = interp1(Observer.lambda, Observer.responses(:,cc), lambda_act);
            I = interp1(Illuminant.lambda, Illuminant.power, lambda_act);
            R = R_act(:,s)';
            XYZ_act(s,cc) = sum(O.*R.*I) * d_lambda;
            
            % Estimated color
            d_lambda = abs(mean(diff(lambda_est)));
            O = interp1(Observer.lambda, Observer.responses(:,cc), lambda_est);
            P = SPD_est(:,s)';
            XYZ_est(s,cc) = sum(O.*P) * d_lambda;
            
        end
        
    end
    
    disp([ 'mean(XYZ_est(:)) = ' num2str(mean(XYZ_est(:))) ])
    disp([ 'mean(XYZ_act(:)) = ' num2str(mean(XYZ_act(:))) ])
    
    % Normalize values
    O = interp1(Observer.lambda, Observer.responses(:,2), lambda_act);
    I = interp1(Illuminant.lambda, Illuminant.power, lambda_act);
    d_lambda = abs(mean(diff(lambda_act)));
    N = sum(O.*I) * d_lambda;
    
    XYZ_est = XYZ_est ./ N;
    XYZ_act = XYZ_act ./ N;
    
    for s = 1 : qty
        
        RGB_act(s,:) = xyz2rgb(XYZ_act(s,:), 'ColorSpace', 'srgb', 'WhitePoint', 'D65', 'OutputType', 'double');
        RGB_est(s,:) = xyz2rgb(XYZ_est(s,:), 'ColorSpace', 'srgb', 'WhitePoint', 'D65', 'OutputType', 'double');
        
        if ~isempty(find(RGB_act(s,:)>1)) || ~isempty(find(RGB_act(s,:)<0))
            warning(['RGB_act(' num2str(s) ',:) = ' num2str(RGB_act(s,:))])
        end
        if ~isempty(find(RGB_est(s,:)>1)) || ~isempty(find(RGB_est(s,:)<0))
            warning(['RGB_est(' num2str(s) ',:) = ' num2str(RGB_est(s,:))])
        end
        
        Lab_act(s,:) = xyz2lab(XYZ_act(s,:), 'WhitePoint', 'D65');
        Lab_est(s,:) = xyz2lab(XYZ_est(s,:), 'WhitePoint', 'D65');
        
        dE(s) = color_difference(Lab_act(s,:), Lab_est(s,:), 'CIEDE2000');
        
    end
    
    RGB_act(RGB_act<0) = 0;
    RGB_est(RGB_est<0) = 0;
    RGB_act(RGB_act>1) = 1;
    RGB_est(RGB_est>1) = 1;
    
    JND = dE ./ Observer.Lab_JND;
    
    %%
    
%     err_min = 0;
%     err_max = 0;
    
    figure(105)
        clf
        set(gcf,'color','white')
        pos = get(gcf,'position');
        set(gcf,'position',[pos(1) 200 1000 600])
        
        for s = 1 : qty
            subplot(4,6,s)
            hold on
            
            xlim([400 700])
            ylim([0 1])
            
            fill([550 550 400 400], [1 0 0 1], RGB_act(s,:),'EdgeColor','none')
            fill([700 700 550 550], [1 0 0 1], RGB_est(s,:),'EdgeColor','none')
            
            grayscale = dot(Observer.grayscale_weights, RGB_act(s,:));
            if grayscale < 0.5
                col = [1 1 1];
            else
                col = [0 0 0];
            end
            
            y_act = R_act(:,s) .* I_gain;
            y_est = SPD_est(:,s);
            
            plot(lambda_act, y_act, '-', 'Color', col, 'LineWidth', 1)
            plot(lambda_est, y_est, ':', 'Color', col, 'LineWidth', 2)
            
            y_resample = interp1(lambda_act, y_act, lambda_est)';
            
%             err_min = min([err_min; y_est-y_resample]);
%             err_max = max([err_max; y_est-y_resample]);            
            
            grid on
            set(gca,'XTick', stations)
            set(gca,'XTickLabel',{})
            set(gca,'YTick', [])
            
            text(min(xlim), max(ylim), ['\bf' num2str(s) ': \rm' num2str(round(JND(s)*10)/10) ' JND'],'HorizontalAlignment','left','VerticalAlignment','bottom','FontSize',12)
            
        end
        
%         disp(['Curve alignment: ' num2str(err_min + err_max)])
        disp(['mean(JND): ' num2str(mean(JND))])
    
% end


















































